# This script is designed to run with Understand - CodeCheck
# Rewritten by Robby Bennett
# 2025-01-13


from understand import Ent


REF_KINDS = 'define, ada declare body'
ENT_KINDS = '''\
    ada entry, ada function, ada procedure, ada protected, ada task,
    basic method,
    c function,
    csharp method,
    fortran block data, fortran function, fortran interface, fortran program, fortran subroutine,
    java method,
    jovial subroutine,
    pascal compunit, pascal function, pascal procedure,
    python function,
    web function, web method'''


def ids():
    return ('HIS_02', 'METRIC_07', 'AC_HIS_02')


def name(id):
    return {
        'HIS_02': '''Published Standards/Hersteller Initiative Software (HIS) Metrics/2. Number of Paths (PATH)''',
        'METRIC_07': '''All Checks/Metrics/Program Unit Path Count''',
        'AC_HIS_02': '''All Checks/Number of Paths (PATH)''',
    }[id]


def tags(id):
    return {
        'HIS_02': [
            'Language: Ada',
            'Language: C',
            'Language: C++',
            'Language: C#',
            'Language: Delphi/Pascal',
            'Language: Fortran',
            'Language: Java',
            'Language: Jovial',
            'Language: Python',
            'Language: Visual Basic [.NET]',
            'Language: Web',
            'Standard: Hersteller Initiative Software (HIS) Metrics',
            'Metrics',
        ],
        'METRIC_07': [
            'Language: Ada',
            'Language: C',
            'Language: C++',
            'Language: C#',
            'Language: Delphi/Pascal',
            'Language: Fortran',
            'Language: Java',
            'Language: Jovial',
            'Language: Python',
            'Language: Visual Basic [.NET]',
            'Language: Web',
            'Metrics',
        ],
        'AC_HIS_02': [
            'Language: Ada',
            'Language: C',
            'Language: C++',
            'Language: C#',
            'Language: Delphi/Pascal',
            'Language: Fortran',
            'Language: Java',
            'Language: Jovial',
            'Language: Python',
            'Language: Visual Basic [.NET]',
            'Language: Web',
            'Metrics',
        ],
    }.get(id)


def detailed_description(id):
    return '''\
<p><b>Title</b></p>

<p>Number of Paths</p>

<p><b>Description</b></p>

<p>Number of non cyclic remark paths (i.e. minimum number of necessary cases of test)</p>

<p>Measurement for the reduction of PATH: Allocation into several functions, display in sub-functions.</p>

<p>Acceptable Range &lt;= 80</p>

<p>Does not count abnormal exits or gotos.</p>

<p><b>Developer's Notes</b></p>

<p>This check cannot pick up PHP/Javascript functions that are embedded in an html file. They must be placed in a separate .php or .js file.</p>
'''


def test_entity(file):
    return True


def test_global():
    return False


def test_language(language):
    return language in {'Ada', 'Basic', 'C++', 'C#', 'Fortran', 'Java', 'Jovial', 'Pascal', 'Python', 'Web'}


def define_options(check):
    check.options().integer('maxPathsAllowed', 'Maximum paths allowed', 80)


def check(check, file):
    max_paths = check.options().lookup('maxPathsAllowed')

    for ref in file.filerefs(REF_KINDS, ENT_KINDS):
        ent = ref.ent()

        paths = ent.metric('CountPath')
        if paths <= max_paths:
            continue

        check.violation(ent, file, ref.line(), ref.column(), 'Too many paths (%1)', paths)
