# This script is designed to run with Understand - CodeCheck
# Rewritten by Robby Bennett
# 2025-01-08


from understand import Ent


RECURSIVE = -1

REF_KINDS = 'define, ada declare body, vhdl declare'
ENT_KINDS = '''\
    ada entry, ada function, ada procedure, ada protected, ada task,
    basic method,
    c function,
    csharp method,
    fortran block data, fortran function, fortran interface, fortran program, fortran subroutine,
    java method,
    jovial subroutine,
    pascal compunit, pascal function, pascal procedure,
    python function,
    vhdl procedure, vhdl function, vhdl process, vhdl architecture,
    web function, web method'''


def ids():
    return ('HIS_09', 'AC_HIS_09')


def name(id):
    return {
        'HIS_09': '''Published Standards/Hersteller Initiative Software (HIS) Metrics/9. Number of call levels (LEVEL)''',
        'AC_HIS_09': '''All Checks/Number of call levels (LEVEL)''',
    }[id]


def tags(id):
    return {
        'HIS_09': [
            'Language: Ada',
            'Language: C',
            'Language: C++',
            'Language: C#',
            'Language: Delphi/Pascal',
            'Language: Fortran',
            'Language: Java',
            'Language: Jovial',
            'Language: Python',
            'Language: VHDL',
            'Language: Visual Basic [.NET]',
            'Language: Web',
            'Standard: Hersteller Initiative Software (HIS) Metrics',
            'Functions',
        ],
        'AC_HIS_09': [
            'Language: Ada',
            'Language: C',
            'Language: C++',
            'Language: C#',
            'Language: Delphi/Pascal',
            'Language: Fortran',
            'Language: Java',
            'Language: Jovial',
            'Language: Python',
            'Language: VHDL',
            'Language: Visual Basic [.NET]',
            'Language: Web',
            'Functions',
        ],
    }.get(id)


def detailed_description(id):
    return '''\
<p><b>Title</b></p>

Number of call levels

<p><b>Description</b></p>

<p>Maximum nesting levels within a function + 1</p>

<p>Acceptable Range &lt;= 4</p>

<p><b>Developer's Notes</b></p>

<p>This check cannot pick up PHP/Javascript functions that are embedded in an html file. They must be placed in a separate .php or .js file.</p>
'''


def test_entity(file):
    return True


def test_global():
    return False


def test_language(language):
    return language in {'Ada', 'Basic', 'C++', 'C#', 'Fortran', 'Java', 'Jovial', 'Pascal', 'Python' 'VHDL', 'Web'}


def define_options(check):
    check.options().integer('maxCallDepth', 'Maximum call levels', 4)
    check.options().checkbox('ignoreRecursion', 'Skip recursive functions', False)


def check(check, file):
    max_call_depth = check.options().lookup('maxCallDepth')
    ignore_recursion = check.options().lookup('ignoreRecursion')

    known: dict[Ent, int] = dict()

    for ref in file.filerefs(REF_KINDS, ENT_KINDS, True):
        ent = ref.ent()

        depth = get_depth(ent, known)
        if depth == RECURSIVE:
            if not ignore_recursion:
                check.violation(ent, file, ref.line(), ref.column(), "Recursion detected, can't count call levels")
            continue

        depth += 1
        if depth > max_call_depth:
            check.violation(ent, file, ref.line(), ref.column(), 'Too many call levels (%1)', depth)


def get_depth(func: Ent, known: dict[Ent, int]) -> int:
    known_depth = known.get(func)
    if known_depth != None:
        return known_depth

    known[func] = RECURSIVE

    for call in func.refs('call ~inactive, use ptr ~inactive', ENT_KINDS, True):
        depth = get_depth(call.ent(), known)
        if depth == RECURSIVE:
            return RECURSIVE
        if depth > known[func]:
            known[func] = depth

    known[func] += 1
    return known[func]
