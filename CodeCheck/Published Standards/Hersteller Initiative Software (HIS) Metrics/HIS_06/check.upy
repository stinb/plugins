# This script is designed to run with Understand - CodeCheck
# Rewritten by Robby Bennett
# 2025-01-13


from understand import Ent


REF_KINDS = 'define, ada declare body, vhdl declare'
ENT_KINDS = '''\
    ada entry, ada function, ada procedure, ada protected, ada task,
    basic method,
    c function,
    csharp method,
    fortran block data, fortran function, fortran interface, fortran program, fortran subroutine,
    java method,
    jovial subroutine,
    pascal compunit, pascal function, pascal procedure,
    python function,
    vhdl procedure, vhdl function, vhdl process, vhdl architecture,
    web function, web method'''


def ids():
    return ('HIS_05', 'METRIC_01', 'AC_HIS_05')


def name(id):
    return {
        'HIS_05': '''Published Standards/Hersteller Initiative Software (HIS) Metrics/5. Calling Functions (CALLING)''',
        'METRIC_01': '''All Checks/Metrics/Program Unit Callby Count''',
        'AC_HIS_05': '''All Checks/Calling Functions (CALLING)''',
    }[id]


def tags(id):
    return {
        'HIS_05': [
            'Language: Ada',
            'Language: C',
            'Language: C++',
            'Language: C#',
            'Language: Delphi/Pascal',
            'Language: Fortran',
            'Language: Java',
            'Language: Jovial',
            'Language: Python',
            'Language: VHDL',
            'Language: Visual Basic [.NET]',
            'Language: Web',
            'Standard: Hersteller Initiative Software (HIS) Metrics',
            'Functions',
            'Metrics',
        ],
        'METRIC_01': [
            'Language: Ada',
            'Language: C',
            'Language: C++',
            'Language: C#',
            'Language: Delphi/Pascal',
            'Language: Fortran',
            'Language: Java',
            'Language: Jovial',
            'Language: Python',
            'Language: VHDL',
            'Language: Visual Basic [.NET]',
            'Language: Web',
            'Functions',
            'Metrics',
        ],
        'AC_HIS_05': [
            'Language: Ada',
            'Language: C',
            'Language: C++',
            'Language: C#',
            'Language: Delphi/Pascal',
            'Language: Fortran',
            'Language: Java',
            'Language: Jovial',
            'Language: Python',
            'Language: VHDL',
            'Language: Visual Basic [.NET]',
            'Language: Web',
            'Functions',
            'Metrics',
        ],
    }.get(id)


def detailed_description(id):
    return '''\
<p><b>Title</b></p>

<p>Calling Functions</p>

<p><b>Description</b></p>

<p>The range 1 to 5 only makes sense when the entire system is analysed. With subsystems and libraries 0 to 5 is permissible. For the complete system there is the exception of main(), since this will only be called by the startup code.</p>

<p>Maximum allowed: 5</p>

<p><b>Developer's Notes</b></p>

<p>This check cannot pick up PHP/Javascript functions that are embedded in an html file. They must be placed in a separate .php or .js file.</p>
'''


def test_entity(file):
    return True


def test_global():
    return False


def test_language(language):
    return language in {'Ada', 'Basic', 'C++', 'C#', 'Fortran', 'Java', 'Jovial', 'Pascal', 'Python', 'VHDL', 'Web'}


def define_options(check):
    check.options().integer('MaxCallers', 'Maximum calling functions', 5)


def check(check, file):
    max_callers = check.options().lookup('MaxCallers')

    for ref in file.filerefs(REF_KINDS, ENT_KINDS):
        ent = ref.ent()

        callers = len(ent.ents('callby'))
        if callers <= max_callers:
            continue

        check.violation(ent, file, ref.line(), ref.column(), 'Called by too many functions (%1)', callers)
