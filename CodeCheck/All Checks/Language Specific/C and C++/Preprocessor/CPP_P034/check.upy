# This script is designed to run with Understand - CodeCheck
# Rewritten by Robby Bennett
# 2026-01-22


import re

from understand import Check, Ent


ERR1 = 'Non-recommended characters used in header file name'


def ids():
    return ('MISRA12_20.2', 'MISRA23_20.2', 'CPP_P034')


def name(id):
    return {
        'MISRA12_20.2': '''Published Standards/MISRA C 2012/\
20.2 Invalid Header Name''',
        'MISRA23_20.2': '''Published Standards/MISRA C 2023/\
20.2 Invalid Header Name''',
        'CPP_P034': '''All Checks/Language Specific/C and C++/Preprocessor/\
Invalid Header Name''',
    }.get(id)


def tags(id):
    return {
        'MISRA12_20.2': [
            'Preprocessor',
            'Language: C',
            'Language: C++',
            'Standard: MISRA C 2012',
            'Category: Required',
        ],
        'MISRA23_20.2': [
            'Preprocessor',
            'Language: C',
            'Language: C++',
            'Standard: MISRA C 2023',
            'Category: Required',
        ],
        'CPP_P034': [
            'Preprocessor',
            'Language: C',
            'Language: C++',
        ],
    }.get(id)


def detailed_description(id):
    return '''\
<p><b>Title</b></p>

<p>The <code>'</code>, <code>"</code> or <code>\\</code> characters and the <code>/*</code> or <code>//</code> character sequences shall not occur in a <i>header file</i> name.</p>

<p><b>Rationale</b></p>

<p>The behaviour is undefined if:</p>

<ul>
<li>
The <code>'</code>, <code>"</code> or <code>\\</code> characters, or the <code>/*</code> or <code>//</code> character sequences are used between <code>&lt;</code> and <code>&gt;</code> delimiters in a header name preprocessing token;
</li>
<li>
The <code>'</code> or <code>\\</code> characters, or the <code>/*</code> or <code>//</code> character sequences are used between the <code>"</code> delimiters in a header name preprocessing token.
</li>
</ul>

<p><i>Note:</i> although use of the <code>\\</code> character results in undefined behaviour, many implementations willaccept the <code>/</code> character in its place.</p>

<p><b>Example</b></p>

<pre><code language="C++">\
#include "fi'le.h"   /* Non-compliant */
</code></pre>
'''


def test_entity(file):
    return True


def test_global():
    return False


def test_language(language):
    return language == 'C++'


def check(check: Check, file: Ent):
    lexer = None

    for ref in file.filerefs('Include', 'Header File'):
        line = ref.line()
        column = ref.column()

        if not lexer:
            lexer = file.lexer(False)

        lex = lexer.lexeme(line, column)
        while lex and lex.token() != 'String':
            lex = lex.next(True, True)

        if not lex or not re.search(r'([\']{1}|[\\]{1}|[\/]{2}|(\/\*))', lex.text()):
            continue

        check.violation(ref.ent(), file, ref.line(), ref.column(), ERR1)
